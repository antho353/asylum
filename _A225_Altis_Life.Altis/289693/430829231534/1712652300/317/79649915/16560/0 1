#include"..\..\..\..\..\..\macro.h"
if(scriptAvailable(5)) exitWith{["You can only attempt to manage your listings in the Asylum Exchange Storage every couple seconds!","basic"]spawn life_fnc_handleMessage;};if((life_cashCache!=((life_cash/4)+7))||(life_atmcashCache!=((life_atmcash/4)+5))) exitWith{[["-HACKEDMONEY-",player,profileName,format["File: %1 - money tampering attempted! Cash: %2 - Expected cash: %3 | Bank: %4 - Expected bank: %5.",_fnc_scriptName,[life_cash]call life_fnc_numberText,[((life_cashCache-7)*4)]call life_fnc_numberText,[life_atmCash]call life_fnc_numberText,[((life_atmCashCache-5)*4)]call life_fnc_numberText]],"TON_fnc_logIt",2]spawn life_fnc_MP;[[profileName,"Attempting to hack money variable."],"life_fnc_notifyAdmins",-2,false]spawn life_fnc_MP;["MemHackCash",false,false]call compile PreProcessFileLineNumbers"\a3\functions_f\Misc\fn_endMission.sqf";};params[["_selectedType","",[""]],["_control",controlNull]];if(isNull _control) exitWith{};if(_selectedType isEqualTo"") exitWith{};if!(ctrlEnabled _control) exitWith{};private _asy_display=findDisplay 876000;private _menuTitle=_asy_display displayCtrl 876002;private _mainFilterList=_asy_display displayCtrl 876003;private _mainListGroup=_asy_display displayCtrl 876005;private _mainItemList=_mainListGroup controlsGroupCtrl 1000;private _mainItemListBackground=_mainListGroup controlsGroupCtrl 1003;private _rightListGroup=_asy_display displayCtrl 876007;private _rightItemList=_rightListGroup controlsGroupCtrl 1000;private _retrieveButton=_mainListGroup controlsGroupCtrl 1001;private _relistButton=_rightListGroup controlsGroupCtrl 1001;private _itemPreview=_asy_display displayCtrl 876001;private _mainFilterListSelect=lbCurSel _mainFilterList;private _mainItemListSelect=lbCurSel _mainItemList;if((_control isEqualTo _retrieveButton)&&(_mainItemListSelect isEqualTo-1)) exitWith{["You need to select your listing to retrieve it's items!","basic"]spawn life_fnc_handleMessage;};if((_control isEqualTo _relistButton)&&(_mainItemListSelect isEqualTo-1)) exitWith{["You need to select a listing to re-list on the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;};private _listingInfo=switch(_control) do{case _retrieveButton:{[_mainItemList lnbData[_mainItemListSelect,0]]};case _relistButton:{[_mainItemList lnbData[_mainItemListSelect,0]]};default{[]};};switch(_selectedType) do{case"retrieveListing":{closeDialog 0;_listingInfo=parseSimpleArray(_listingInfo select 0);_listingInfo params["_storageID","_purchaserUID","_boughtFromUID","_itemClassname","_itemQuantity","_sellingPrice","_isVirtual","_isPhysical","_expiresTimeSeconds","_boughtTimeSeconds"];life_lagRandomID=round(random(800));private _listingItemData=[];switch(true) do{case(_isVirtual isEqualTo 1):{_listingItemData=[_itemClassname,(["getName",_itemClassname]call life_fnc_virtItemCfg),(["getIcon",_itemClassname]call life_fnc_virtItemCfg)];};default{_listingItemData=[_itemClassname]call life_fnc_fetchCfgDetails};};_listingItemData params["_resourceString","_resourceDisplayName","_resourceImage"];private _dialogQuestion=[format["Do you want to retrieve your %1, from your Asylum Exchange Storage?",_resourceDisplayName],format["Asylum Exchange Storage: %1",_resourceDisplayName],"Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{};switch(true) do{case(_isVirtual isEqualTo 1):{private _totalWeightLeftToCarry=[_itemClassname,_itemQuantity,life_carryWeight,life_maxWeight]call life_fnc_calWeightDiff;if(_totalWeightLeftToCarry<=0) exitWith{[format["You don't have enought space to retrieve %1 from your Asylum Exchange Storage!",_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;};if!(_totalWeightLeftToCarry isEqualTo _itemQuantity) then{if([true,_itemClassname,_totalWeightLeftToCarry]call life_fnc_handleInv) then{private _updatedQuantity=(_itemQuantity-_totalWeightLeftToCarry);[format["You have retrieved %1 from your Asylum Exchange Storage. There is %2 %3(s) left.",_totalWeightLeftToCarry,_updatedQuantity,_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;[[6,[1,getPlayerUID player,player,_storageID,[_itemClassname,_updatedQuantity]]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;[["-EXCHANGESTORAGERETRIEVE-",player,(profileName),format["ID: %3, Retrieved item from Exchange Storage: Virtual Item: %1, Quantity Taken: %2",_resourceDisplayName,_totalWeightLeftToCarry,_storageID]],"TON_fnc_logIt",2]spawn life_fnc_MP;};}else{if([true,_itemClassname,_itemQuantity]call life_fnc_handleInv) then{[format["You have retrieved all %1 %2(s) from your Asylum Exchange Storage!",_itemQuantity,_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;[[6,[1,getPlayerUID player,player,_storageID,[_itemClassname,0]]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;[["-EXCHANGESTORAGERETRIEVE-",player,(profileName),format["ID: %3, Retrieved item from Exchange Storage: Virtual Item: %1, Quantity Taken: %2",_resourceDisplayName,_itemQuantity,_storageID]],"TON_fnc_logIt",2]spawn life_fnc_MP;};};};case(_isPhysical isEqualTo 1):{private"_vehicle";if!(isNull objectParent player) then{_vehicle=objectParent player;}else{private _nearVehicles=nearestObjects[getPos player,["Car","Air","Ship"],35];_vehicle=_nearVehicles param[_nearVehicles findIf{((_x getVariable["ga_vehOwners",[[]]]select 0) select 0) isEqualTo getPlayerUID player&&alive _x},objNull]};if(isNull _vehicle||isNil"_vehicle") exitWith{["There isn't a vehicle near the NPC to store physical items from your Asylum Exchange Storage!","basic"]spawn life_fnc_handleMessage};private _vehicleDisplayName=[configFile>>"CfgVehicles">>(typeOf _vehicle)]call BIS_fnc_displayName;_vehicle setVariable["ga_activeTrunk",player,true];private _vehPhysicalInventory=+(([getItemCargo _vehicle]call life_fnc_formatContainer)+([getWeaponCargo _vehicle]call life_fnc_formatContainer)+([getMagazineCargo _vehicle]call life_fnc_formatContainer)+([getBackpackCargo _vehicle]call life_fnc_formatContainer));