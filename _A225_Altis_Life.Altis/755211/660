if!(playerSide isEqualTo civilian) exitWith{["<t color='#FF0000' size='1.5' align='center'>Time Trials</t><br/><br/> Time trials are currently only available for civilians","shortwarning"]spawn life_fnc_handleMessage;};params[["_caseType","",[""]],["_timeTrialID",-1,[0]],["_failedText","",[""]]];private _handleWaypoint={params["_playerObj","_posATL","_text","_priority","_imageType"];_imageType=switch(_imageType) do{case 0:{"a3\ui_f\data\map\markers\military\flag_ca.paa"};case 1:{"a3\ui_f\data\map\mapcontrol\waypoint_ca.paa"};case 2:{"a3\ui_f\data\igui\cfg\actions\takeflag_ca.paa"};default{"a3\ui_f\data\map\markers\military\flag_ca.paa"};};private _color=if(_priority==0) then{[1,1,1,0.5]}else{[1,1,1,0.2]};private _wpHandler=addMissionEventHandler["Draw3D",format["drawIcon3D ['%3', %1, %2, 1.1, 1.1, 0, '', 1, 0.05, 'TahomaB', 'center', true];",_color,_posATL,_imageType]];if(_priority==0&&_text!="") then{["timeTrial",[_text]]call BIS_fnc_showNotification;};private _wpTask=_playerObj createSimpleTask["Time Trial"];_wpTask setSimpleTaskDescription[_text,"Time Trials","Time Trials"];_wpTask setSimpleTaskDestination _posATL;_wpTask setTaskState"Assigned";_playerObj setCurrentTask _wpTask;if(_priority==0) then{waitUntil{uiSleep 1;life_timeTrialRemovePrimaryWP||!(_playerObj getVariable['ga_timeTrialActive',false])};life_timeTrialRemovePrimaryWP=false;}else{waitUntil{uiSleep 1;life_timeTrialRemoveSecondaryWP||!(_playerObj getVariable['ga_timeTrialActive',false])};life_timeTrialRemoveSecondaryWP=false;};removeMissionEventHandler["Draw3D",_wpHandler];_wpTask setTaskState"Succeeded";uiSleep(0.3);_playerObj removeSimpleTask _wpTask;};private _handleFailed={params["_playerObj","_failedText"];life_timeTrialRemovePrimaryWP=true;life_timeTrialRemoveSecondaryWP=true;[format["<t color='#FF0000' size='1.5' align='center'>Time Trials</t><br/><br/> You have failed the time trial, %1<br/>",_failedText],"timetrialevent"]spawn life_fnc_handleMessage;player setVariable['ga_timeTrialActive',false,true];};switch(_caseType) do{case("start"):{if(player getVariable['ga_timeTrialActive',false]) exitWith{["<t color='#FF0000' size='1.5' align='center'>Time Trials</t><br/><br/> You already have an active time trial and therefor cannot start a new one ","shortwarning"]spawn life_fnc_handleMessage;};if(_timeTrialID==-1) exitWith{["<t color='#FF0000' size='1.5' align='center'>Time Trials</t><br/><br/> Something went wrong, please send this message to a developer ","shortwarning"]spawn life_fnc_handleMessage;};life_timeTrialRemovePrimaryWP=false;life_timeTrialRemoveSecondaryWP=false;private _timeTrialCfg=["getTimeTrialByID",_timeTrialID]call life_fnc_timeTrialCfg;_timeTrialCfg params["_id","_carCFG","_carPos","_carD","_waypoints","_waypointRadius","_startWaypointRadius"];private _checkNearCars=nearestObjects[_carPos,["landVehicle","Air","Ship"],4]select 0;if(!isNil"_checkNearCars") exitWith{["<t color='#FF0000' size='1.5' align='center'>Time Trials</t><br/><br/> There is currently already a vehicle on the spawnpoint ","shortwarning"]spawn life_fnc_handleMessage;};player setVariable['ga_timeTrialActive',true,true];[player,_carCFG,_carPos,_carD]remoteExec["TON_fnc_createTimeTrialVehSrv",2];[player,_carPos,"Get in the time trial vehicle",0,1]spawn _handleWaypoint;["<t color='#FF0000' size='1.5' align='center'>Time Trials</t><br/><br/> Welcome to time trials! <br/><br/> A vehicle that is associated with the time trial has spawned <br/><br/> Quickly move over to the vehicle to start the time trial ","timetrialevent"]spawn life_fnc_handleMessage;waitUntil{sleep 1;!(isNull objectParent player)&&(objectParent player) getVariable["ga_timeTrialVehicle",false]||!(player getVariable['ga_timeTrialActive',false])||(_carPos distance2D player)>150||!(isNull(findDisplay 314))||!(isNull(findDisplay 2900))};life_timeTrialRemovePrimaryWP=true;if!(player getVariable['ga_timeTrialActive',false]) exitWith{[player,"due to you stopping your time trial"]spawn _handleFailed;};if((_carPos distance2D player)>150) exitWith{[player,"due to moving to far away from the start vehicle"]spawn _handleFailed;};if(!(isNull(findDisplay 314))||!(isNull(findDisplay 2900))) exitWith{[player,"LOL, Do you really think we would let you cheat at this"]spawn _handleFailed;};["<t color='#FF0000' size='1.5' align='center'>Time Trials</t><br/><br/> You have succesfully entered your time trial vehicle, leaving your vehicle will result in failure. <br/><br/> now line up at the start hold there and await the countdown","timetrialevent"]spawn life_fnc_handleMessage;