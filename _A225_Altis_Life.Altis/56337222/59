};if!(_randID isEqualTo life_lagRandomID) exitWith{["Please wait for the exchange...","basic"]spawn life_fnc_handleMessage;};life_atmcash=life_atmcash-_totalCashAmount;life_atmcashCache=((life_atmcash/4)+5);[1]call life_fnc_ClUpdatePartial;[format["Purchase request sent for listing: %1 with a requested amount of %2 for a total price of $%3...",_resourceDisplayName,round _inputedWantedAmount,[_totalCashAmount]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;[["-EXCHANGEPURCHASE-",player,(profileName),format["ID: %7, Purchased a physical item listing from seller: (%1)(%2), Item: %3, Quantity Bought: %4, Quantity Left: %5, Total Purchase Price: $%6",_playerUID,_playerName,_resourceDisplayName,round _inputedWantedAmount,round(_itemQuantity-_inputedWantedAmount),[_totalCashAmount]call life_fnc_numberText,_exchangeID]],"TON_fnc_logIt",2]spawn life_fnc_MP;[[3,[2,_exchangeID,player,_itemClassname,_sellingPrice,round _inputedWantedAmount]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;closeDialog 0;};if(_isVirtual isEqualTo 1) exitWith{private _dialogQuestion=[format["Would you like to purchase %1 which has a stock of %3 and sells for $%2 x 1?",_resourceDisplayName,[_sellingPrice]call life_fnc_numberText,_itemQuantity],"Asylum Exchange Purchase Listing","Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{};["Enter the amount you want to purchase!","basic"]spawn life_fnc_handleMessage;["asy_exchange_input"]call life_fnc_createDialog;((findDisplay 781000) displayCtrl 781001) ctrlSetText(format["Enter the amount of %1 you want to purchase",_resourceDisplayName]);waitUntil{!(isNull(findDisplay 781000))};waitUntil{(isNull(findDisplay 781000)||life_exchangeInput)};if!(life_exchangeInput) exitWith{["You chose not to purchase the selected listing!"]spawn life_fnc_handleMessage};life_exchangeInput=false;private _inputedWantedAmountString=ctrlText 781002;private _inputedWantedAmount=[_inputedWantedAmountString]call BIS_fnc_parseNumber;if(_inputedWantedAmount isEqualTo-1) exitWith{[format["You've entered %1, which isn't a real number!",_inputedWantedAmountString],"basic"]spawn life_fnc_handleMessage;closeDialog 0;};if(_inputedWantedAmount>_itemQuantity) exitWith{[format["You can't purchase more than what is currently available! You requested %1 while the stock was only %2!",_inputedWantedAmount,_itemQuantity]]spawn life_fnc_handleMessage;closeDialog 0;};if(_inputedWantedAmount<1) exitWith{[format["You can't purchase less than what is currently available! You requested less than 1 while the stock was only %1!",_itemQuantity]]spawn life_fnc_handleMessage;closeDialog 0;};private _totalCashAmount=(_inputedWantedAmount*_sellingPrice);if(life_atmcash<_totalCashAmount) exitWith{[format["You do not have $%1 in your bank account, To afford a listing of %2(s)!",[_listingFee]call life_fnc_numberText,_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;};private _randID=life_lagRandomID;life_didServerRespond=false;private _maxDelayTime=time+5;[[player],"TON_fnc_lagCheck",2]spawn life_fnc_MP;waitUntil{time>_maxDelayTime||life_didServerRespond};if(time>_maxDelayTime) exitWith{["Exchange failed, try again.","basic"]spawn life_fnc_handleMessage;};if!(_randID isEqualTo life_lagRandomID) exitWith{["Please wait for the exchange...","basic"]spawn life_fnc_handleMessage;};life_atmcash=life_atmcash-_totalCashAmount;life_atmcashCache=((life_atmcash/4)+5);[1]call life_fnc_ClUpdatePartial;[format["Purchase request sent for listing: %1 with a requested amount of %2 for a total price of $%3...",_resourceDisplayName,round _inputedWantedAmount,[_totalCashAmount]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;[["-EXCHANGEPURCHASE-",player,(profileName),format["ID: %7, Purchased a virtual item listing from seller: (%1)(%2), Item: %3, Quantity Bought: %4, Quantity Left: %5, Total Purchase Price: $%6",_playerUID,_playerName,_resourceDisplayName,round _inputedWantedAmount,round(_itemQuantity-_inputedWantedAmount),[_totalCashAmount]call life_fnc_numberText,_exchangeID]],"TON_fnc_logIt",2]spawn life_fnc_MP;[[1,[2,_exchangeID,player,_itemClassname,_sellingPrice,round _inputedWantedAmount]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;closeDialog 0;};private _dialogQuestion=[format["Would you like to purchase %1 for $%2?",_resourceDisplayName,[_sellingPrice]call life_fnc_numberText],"Asylum Exchange Purchase Listing","Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{};if((_isVehicle isEqualTo 1)&&{life_garageCount>=call life_maxGarageVeh}) exitWith{[format["You have %1 out of %2 max vehicles allowed in your garage, You must sell/destroy in order to purchase a vehicle on the Asylum Exchange!",life_garageCount,(call life_maxGarageVeh)],"basic"]spawn life_fnc_handleMessage;};private _totalCashAmount=(1*_sellingPrice);if(life_atmcash<_totalCashAmount) exitWith{[format["You do not have $%1 in your bank account, To afford the listing of a %2!",[_totalCashAmount]call life_fnc_numberText,_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;};if(_isVehicle isEqualTo 1) then{private _action=false;private _dlcInfo=getAssetDLCInfo[_itemClassname,configFile>>"CfgVehicles"];if(_dlcInfo select 0&&!(_dlcInfo select 1)) then{_action=[format["<t align='center'>You need the %1 DLC in order to use this vehicle. Purchase anyway?</t>",_dlcInfo select 5],"DLC Vehicle Confirmation","Yes","No"]call BIS_fnc_guiMessage;}else{_action=true;};if!(_action) exitWith{};};private _randID=life_lagRandomID;life_didServerRespond=false;private _maxDelayTime=time+5;[[player],"TON_fnc_lagCheck",2]spawn life_fnc_MP;waitUntil{time>_maxDelayTime||life_didServerRespond};if(time>_maxDelayTime) exitWith{["Exchange failed, try again.","basic"]spawn life_fnc_handleMessage;};if!(_randID isEqualTo life_lagRandomID) exitWith{["Please wait for the exchange...","basic"]spawn life_fnc_handleMessage;};life_atmcash=life_atmcash-_totalCashAmount;life_atmcashCache=((life_atmcash/4)+5);[1]call life_fnc_ClUpdatePartial;[format["Purchase request sent for listing: %1 with a requested amount of %2 for a total price of $%3...",_resourceDisplayName,1,[_totalCashAmount]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;[["-EXCHANGEPURCHASE-",player,(profileName),format["ID: %6, Purchased a listing from seller: (%1)(%2), Item: %3, Quantity Bought: %4, Total Purchase Price: $%5",_playerUID,_playerName,_resourceDisplayName,1,[_totalCashAmount]call life_fnc_numberText,_exchangeID]],"TON_fnc_logIt",2]spawn life_fnc_MP;closeDialog 0;uiSleep 0.5;if(_isVehicle isEqualTo 1) exitWith{[[2,[2,_exchangeID,player,_itemClassname,_sellingPrice]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;};};case"removeListing":{_listingInfo=parseSimpleArray(_listingInfo select 0);_listingInfo params["_exchangeID","_playerUID","_playerName","_itemClassname","_vehicleID","_sellingPrice","_itemQuantity","_isVirtual","_isPhysical","_isVehicle","_expiresTimeArray","_boughtTimeArray"];if(_isVirtual isEqualTo 1&&_maxVirtualListing>=5) exitWith{[format["You can only have 5 listings of virtual items in your Exchange Storage, clear out your Exchange Storage to retrieve more. You currently have %1 virtual item listings in storage.",_maxVirtualListing],"basic"]spawn life_fnc_handleMessage;};if(_isPhysical isEqualTo 1&&_maxPhysicalListing>=5) exitWith{[format["You can only have 5 listings of physical items in your Exchange Storage, clear out your Exchange Storage to retrieve more. You currently have %1 physical item listings in storage.",_maxPhysicalListing],"basic"]spawn life_fnc_handleMessage;};if!(_playerUID isEqualTo(getPlayerUID player)) exitWith{};life_lagRandomID=round(random(800));private _listingItemData=[];switch(true) do{case(_isVirtual isEqualTo 1):{_listingItemData=[_itemClassname,(["getName",_itemClassname]call life_fnc_virtItemCfg),(["getIcon",_itemClassname]call life_fnc_virtItemCfg)];};default{_listingItemData=[_itemClassname]call life_fnc_fetchCfgDetails};};_listingItemData params["_resourceString","_resourceDisplayName","_resourceImage"];private _dialogQuestion=[format["Would you like to retract the selected listing for %1 and recieve it back in your Asylum Exchange Storage?",_resourceDisplayName],"Asylum Exchange Retract Listing","Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{["You chose not to retract the selected listing!"]spawn life_fnc_handleMessage;};private _randID=life_lagRandomID;life_didServerRespond=false;private _maxDelayTime=time+5;[[player],"TON_fnc_lagCheck",2]spawn life_fnc_MP;waitUntil{time>_maxDelayTime||life_didServerRespond};if(time>_maxDelayTime) exitWith{["Exchange failed, try again.","basic"]spawn life_fnc_handleMessage;};if!(_randID isEqualTo life_lagRandomID) exitWith{["Please wait for the exchange...","basic"]spawn life_fnc_handleMessage;};[format["Retracting request sent for your listing of %1..",_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;[[4,[_exchangeID,player,getPlayerUID player,_itemClassname]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;[["-EXCHANGERETRACT-",player,(profileName),format["ID: %4, Retracted a listing: Item: %1, Quantity: %2, Set Price: $%3",_resourceDisplayName,_itemQuantity,[_sellingPrice]call life_fnc_numberText,_exchangeID]],"TON_fnc_logIt",2]spawn life_fnc_MP;closeDialog 0;};};