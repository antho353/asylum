private _countWeapons1=count(_vehWeapon select 0);private _countAmmo1=count(_vehAmmo select 0);private _checkToExit=false;private _exitOut=false;if!((_vehItem select 0) findIf{_x find"Toolkit"isEqualTo-1&&_x!="FirstAidKit"}isEqualTo-1) then{_checkToExit=true};if(_vehicleObject getVariable["ga_vinv",[[],0]]select 1>0||!((_countWeapons1+_countAmmo1) isEqualTo 0)) then{_checkToExit=true};if!((_vehBackpack select 0) findIf{_x find"Parachute"isEqualTo-1&&_x!="B_AssaultPack_cbr"}isEqualTo-1) then{_checkToExit=true};if(_checkToExit) then{private _action=["It appears you have some items in the trunk or vehicle inventory which will be removed upon inserting into the Asylum Exchange. Continue anyway?","Inventory Present Alert","Yes","No"]call BIS_fnc_GUIMessage;if!(_action) exitWith{_exitOut=true};};if(_exitOut) exitWith{};[format["Please enter the asking price for %1, for the Asylum Exchange",_vehicleDisplayName]]spawn life_fnc_handleMessage;["asy_exchange_input"]call life_fnc_createDialog;((findDisplay 781000) displayCtrl 781001) ctrlSetText(format["Enter the selling price for your %1",_vehicleDisplayName]);waitUntil{!(isNull(findDisplay 781000))};waitUntil{(isNull(findDisplay 781000)||life_exchangeInput)};if!(life_exchangeInput) exitWith{};life_exchangeInput=false;private _inputedAskingPriceString=ctrlText 781002;private _inputedAskingPrice=[_inputedAskingPriceString]call BIS_fnc_parseNumber;if(_inputedAskingPrice isEqualTo-1) exitWith{[format["You've entered %1, which isn't a real number!",_inputedAskingPriceString],"basic"]spawn life_fnc_handleMessage;closeDialog 0;};if(_inputedAskingPrice<(["getMinimumPrice",_vehicleClassname]call life_fnc_exchangeCfg)) exitWith{[format["You've entered %1, but the minimum price you can input is %2!",[_inputedAskingPrice]call life_fnc_numberText,[(["getMinimumPrice",_vehicleClassname]call life_fnc_exchangeCfg)]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;closeDialog 0;};if(_inputedAskingPrice>(["getMaximumPrice",_vehicleClassname]call life_fnc_exchangeCfg)) exitWith{[format["You've entered %1, but the maximum price you can input is %2!",[_inputedAskingPrice]call life_fnc_numberText,[(["getMaximumPrice",_vehicleClassname]call life_fnc_exchangeCfg)]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;closeDialog 0;};if((player distance2D _vehicleObjectPos)>25) exitWith{["You must be within 25 meters of your car to insert into the exchange!","basic"]spawn life_fnc_handleMessage;};if(isNull _vehicleObject) exitWith{};private _listingFee=(_inputedAskingPrice*0.05);if(life_atmcash<_listingFee) exitWith{[format["You do not have $%1 in your bank account, To afford the listing fee for this item!",[_listingFee]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;};private _dialogQuestion=[format["Are you willing to pay a listing fee of $%1 for your %2?",[_listingFee]call life_fnc_numberText,_vehicleDisplayName],"Asylum Exchange","Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{["You chose not to list your vehicle on the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;closeDialog 0;};private _randID=life_lagRandomID;life_didServerRespond=false;private _maxDelayTime=time+5;[[player],"TON_fnc_lagCheck",2]spawn life_fnc_MP;waitUntil{time>_maxDelayTime||life_didServerRespond};if(time>_maxDelayTime) exitWith{["Exchange failed, try again.","basic"]spawn life_fnc_handleMessage;};if!(_randID isEqualTo life_lagRandomID) exitWith{["Please wait for the exchange...","basic"]spawn life_fnc_handleMessage;};life_atmcash=life_atmcash-_listingFee;life_atmcashCache=((life_atmcash/4)+5);[1]call life_fnc_ClUpdatePartial;[format["You have inserted your %3 for $%1 with a listing fee of $%2 on the Asylum Exchange. If your listing fails to sell within 7 days then your vehicle will be put back into your garage!",[_inputedAskingPrice]call life_fnc_numberText,[_listingFee]call life_fnc_numberText,_vehicleDisplayName],"exchange"]spawn life_fnc_handleMessage;[[2,[1,player,getPlayerUID player,_vehicleClassname,_inputedAskingPrice,_vehiclePlateID,_vehicleObject,_listingFee]],"TON_fnc_exchangeSystemSRV",2]spawn life_fnc_MP;[["-EXCHANGELISTED-",player,(profileName),format["Created a vehicle listing: Item: %1, Quantity Inputed: %2, Set Price: $%3, Fee: $%4",_vehicleDisplayName,1,[_inputedAskingPrice]call life_fnc_numberText,[_listingFee]call life_fnc_numberText]],"TON_fnc_logIt",2]spawn life_fnc_MP;closeDialog 0;};case"physicalItem":{if(!_subscriber&&_maxPhysicalListing>=10) exitWith{[format["You can only have 10 listings of physical items in the Asylum Exchange, clear out your Asylum Exchange listings to list more. You currently have %1 physical item listings listed. Asylum Subscribers recieve an extra 10 physical item listing space in the Asylum Exchange.",_maxPhysicalListing],"basic"]spawn life_fnc_handleMessage;};if(_subscriber&&_maxPhysicalListing>=20) exitWith{[format["You can only have 20 listings of physical items in the Asylum Exchange, clear out your Asylum Exchange listings to list more. You currently have %1 physical item listings listed. ",_maxPhysicalListing],"basic"]spawn life_fnc_handleMessage;};private _nearVehicles=nearestObjects[getPos player,["Car","Air","Ship"],35];private _vehicle=_nearVehicles param[_nearVehicles findIf{(((_x getVariable["ga_vehOwners",[[]]]param[0,[]]) param[0,""]) isEqualTo getPlayerUID player)&&((_x getVariable["ga_activeTrunk",objNull]) isEqualTo objNull)&&((_x getVariable["ga_veh_in_use",objNull]) isEqualTo objNull)&&alive _x},objNull];if(isNull _vehicle||isNil"_vehicle") exitWith{["There isn't a vehicle near the NPC to list physical items from that you own!","basic"]spawn life_fnc_handleMessage};[_vehicle]call _lockTrunk;private _dialogQuestion=["For the physical item you decide to list, the entire amount of that item in your vehicle's trunk will be listed on the Asylum Exchange","Asylum Exchange","Okay","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{[_vehicle]call _unlockTrunk;["You chose not to list your physical items on the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;};private _selectedPhysicalItem=[];private _whitelistedPhysicalItems=([1,"Weapons"]call life_fnc_exchangeCfg)+([1,"Ammo"]call life_fnc_exchangeCfg)+([1,"Attachments"]call life_fnc_exchangeCfg)+([1,"Headgear"]call life_fnc_exchangeCfg)+([1,"Glasses"]call life_fnc_exchangeCfg)+([1,"Vests"]call life_fnc_exchangeCfg)+([1,"Uniforms"]call life_fnc_exchangeCfg)+([1,"Backpacks"]call life_fnc_exchangeCfg);private _prePhysicalInventory=+(([getItemCargo _vehicle]call life_fnc_formatContainer)+([getWeaponCargo _vehicle]call life_fnc_formatContainer)+([getMagazineCargo _vehicle]call life_fnc_formatContainer)+([getBackpackCargo _vehicle]call life_fnc_formatContainer));private _toExit=false;{_x params["_xItem","_xCount"];if(_toExit) exitWith{};if(_xItem in _whitelistedPhysicalItems) then{private _dialogQuestion=[format["Would you like to list %1 %2 from your %3's trunk?",_xCount,([_xItem]call life_fnc_fetchCfgDetails select 1),[configFile>>"CfgVehicles">>typeOf _vehicle]call BIS_fnc_displayName],"Asylum Exchange","Yes","No"]call BIS_fnc_guiMessage;if(_dialogQuestion) exitWith{_prePhysicalInventory=_prePhysicalInventory-[_x];_selectedPhysicalItem=_x;_toExit=true;};};}forEach _prePhysicalInventory;private _newPhysicalInventory=+_prePhysicalInventory;if(_selectedPhysicalItem isEqualTo[]) exitWith{[_vehicle]call _unlockTrunk;["You didn't choose a item to list OR you had no whitelisted physical items in your trunk!","basic"]spawn life_fnc_handleMessage;};private _selPhysicalItem=_selectedPhysicalItem param[0,""];private _selPhysicalItemCount=_selectedPhysicalItem param[1,0];private _selPhysicalItemName=([_selPhysicalItem]call life_fnc_fetchCfgDetails param[1,""]);["asy_exchange_input"]call life_fnc_createDialog;((findDisplay 781000) displayCtrl 781001) ctrlSetText(format["Enter the selling price for your per item of %1",_selPhysicalItemName]);waitUntil{!(isNull(findDisplay 781000))};waitUntil{(isNull(findDisplay 781000)||life_exchangeInput)};if!(life_exchangeInput) exitWith{[_vehicle]call _unlockTrunk;};life_exchangeInput=false;private _inputedAskingPriceString=ctrlText 781002;private _inputedAskingPrice=[_inputedAskingPriceString]call BIS_fnc_parseNumber;if(_inputedAskingPrice isEqualTo-1) exitWith{[format["You've entered %1, which isn't a real number!",_inputedAskingPriceString],"basic"]spawn life_fnc_handleMessage;closeDialog 0;};if(_inputedAskingPrice<(["getMinimumPrice",_selPhysicalItem]call life_fnc_exchangeCfg)) exitWith{[format["You've entered %1, but the minimum price you can input is %2!",[_inputedAskingPrice]call life_fnc_numberText,[(["getMinimumPrice",_selPhysicalItem]call life_fnc_exchangeCfg)]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;closeDialog 0;[_vehicle]call _unlockTrunk;};if(_inputedAskingPrice>(["getMaximumPrice",_selPhysicalItem]call life_fnc_exchangeCfg)) exitWith{_vehicle setVariable["ga_activeTrunk",nil,true];[format["You've entered %1, but the maximum price you can input is %2!",[_inputedAskingPrice]call life_fnc_numberText,[(["getMaximumPrice",_selPhysicalItem]call life_fnc_exchangeCfg)]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;closeDialog 0;[_vehicle]call _unlockTrunk;};if(_selPhysicalItem isEqualTo""||_selPhysicalItemCount isEqualTo 0) exitWith{[_vehicle]call _unlockTrunk;};private _listingFee=((_inputedAskingPrice*_selPhysicalItemCount)*0.05);if(life_atmcash<_listingFee) exitWith{[format["You do not have $%1 in your bank account, To afford the listing fee for this item!",[_listingFee]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;[_vehicle]call _unlockTrunk;};private _dialogQuestion=[format["Are you willing to pay a total listing fee of $%1 for %2 %3(s)?",[_listingFee]call life_fnc_numberText,_selPhysicalItemCount,_selPhysicalItemName],"Asylum Exchange","Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{["You chose not to list your resources on the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;closeDialog 0;[_vehicle]call _unlockTrunk;};private _randID=life_lagRandomID;life_didServerRespond=false;private _maxDelayTime=time+5;[[player],"TON_fnc_lagCheck",2]spawn life_fnc_MP;waitUntil{time>_maxDelayTime||life_didServerRespond};if(time>_maxDelayTime) exitWith{[_vehicle]call _unlockTrunk;["Exchange failed, try again.","basic"]spawn life_fnc_handleMessage;};if!(_randID isEqualTo life_lagRandomID) exitWith{[_vehicle]call _unlockTrunk;["Please wait for the exchange...","basic"]spawn life_fnc_handleMessage;};life_atmcash=life_atmcash-_listingFee;life_atmcashCache=((life_atmcash/4)+5);[1]call life_fnc_ClUpdatePartial;clearMagazineCargoGlobal _vehicle;clearBackpackCargoGlobal _vehicle;clearItemCargoGlobal _vehicle;clearWeaponCargoGlobal _vehicle;{_vehicle addItemCargoGlobal _x;}forEach _newPhysicalInventory;[_vehicle]call _unlockTrunk;[format["Your %4 %1(s) have been listed on the Asylum Exchange for $%2 x 1 with a listing fee of $%3. If your listing fails to sell within 7 days then your items will be put into your Asylum Exchange Storage!",_selPhysicalItemName,[_inputedAskingPrice]call life_fnc_numberText,[_listingFee]call life_fnc_numberText,_selPhysicalItemCount],"exchange"]spawn life_fnc_handleMessage;[[3,[1,player,getPlayerUID player,_selPhysicalItem,_inputedAskingPrice,_selPhysicalItemCount,_listingFee]],"TON_fnc_exchangeSystemSRV",2]spawn life_fnc_MP;[["-EXCHANGELISTED-",player,(profileName),format["Created a virtual item listing: Item: %1, Quantity Inputed: %2, Set Price: $%3, Fee: $%4",_selPhysicalItemName,_selPhysicalItemCount,[_inputedAskingPrice]call life_fnc_numberText,[_listingFee]call life_fnc_numberText]],"TON_fnc_logIt",2]spawn life_fnc_MP;closeDialog 0;};};