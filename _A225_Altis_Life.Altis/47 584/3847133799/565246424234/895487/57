#include"..\..\..\..\macro.h"
if(scriptAvailable(8)) exitWith{["You can only attempt to open the Asylum Exchange every 8 seconds!","basic"]spawn life_fnc_handleMessage;};params["_target","_caller","_actionID"];if(!alive player||life_action_in_use) exitWith{};if!(SRV_exchangeIsReady) exitWith{["The Asylum Exchange is still being initialized, wait a moment!","basic"]};if(life_exchangePlayerOwnedListings isEqualTo[]||life_exchangeAllListings isEqualTo[]||!(life_exchangeRequested)) then{life_exchangeRequested=false;[[5,[0,getPlayerUID player,player]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;waitUntil{uiSleep 0.1;life_exchangeRequested};};life_exchangeRequested=false;if(life_exchangeStorageMaxListings isEqualTo[0,0]||!(life_exchangeStorageRequested)) then{life_exchangeStorageRequested=false;[[7,[1,getPlayerUID player,player]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;waitUntil{uiSleep 0.1;life_exchangeStorageRequested};};life_exchangeStorageRequested=false;while{dialog}do{closeDialog 0};disableSerialization;["exchangeMenu"]call life_fnc_createDialog;private _asy_display=findDisplay 875000;private _menuTitle=_asy_display displayCtrl 875002;private _mainFilterList=_asy_display displayCtrl 875003;private _leftFilterList=_asy_display displayCtrl 875004;private _mainListGroup=_asy_display displayCtrl 875005;private _mainItemList=_mainListGroup controlsGroupCtrl 1000;private _mainItemListBackground=_mainListGroup controlsGroupCtrl 1003;private _leftListGroup=_asy_display displayCtrl 875006;private _leftItemList=_leftListGroup controlsGroupCtrl 1000;private _leftItemListBackground=_mainListGroup controlsGroupCtrl 1003;private _rightListGroup=_asy_display displayCtrl 875007;private _rightItemList=_rightListGroup controlsGroupCtrl 1000;private _retractListingButton=_mainListGroup controlsGroupCtrl 1001;private _purchaseListingButton=_rightListGroup controlsGroupCtrl 1001;private _checkAvailButton=_leftListGroup controlsGroupCtrl 1001;_mainFilterList lbSetCurSel 0;_leftFilterList lbSetCurSel 0;_menuTitle ctrlSetText(format["Asylum Grand Exchange",profileName,(getPlayerUID player)]);{_x params["_title"];if!(_title in["My Listings","All Listings"]) then{private _index=_leftFilterList lbAdd _title;_leftFilterList lbSetData[_index,_title];}else{private _index=_mainFilterList lbAdd _title;_mainFilterList lbSetData[_index,_title];};}forEach["Virtual Items","Weapons","Vehicles","Ammo","Attachments","Headgear","Glasses","Vests","Uniforms","Backpacks","My Listings","All Listings"];{_x lnbAddColumn 0.70}forEach[_mainItemList,_leftItemList];if((lbSize _mainFilterList)<=1) then{_mainFilterList ctrlShow false;private _mainFilterListPosition=ctrlPosition _mainFilterList;private _controls=((allControls _asy_display) select{((ctrlParentControlsGroup _x) isEqualTo _mainListGroup)&&!((ctrlIDC _x) in[1000,1002,1003])});_mainListGroup ctrlSetPosition[_mainFilterListPosition select 0,_mainFilterListPosition select 1];{_x ctrlSetPosition[(ctrlPosition _x) select 0,((ctrlPosition _x) select 1)+(_mainFilterListPosition select 3)+0.0055]}forEach _controls;{_x ctrlSetPosition[(ctrlPosition _x) select 0,(ctrlPosition _x) select 1,(ctrlPosition _x) select 2,((ctrlPosition _x) select 3)+(_mainFilterListPosition select 3)+0.0055]}forEach[_mainItemList,_mainItemListBackground];{_x ctrlCommit 0}forEach(allControls _asy_display);};if((lbSize _leftFilterList)<=1) then{_leftFilterList ctrlShow false;private _leftFilterListPosition=ctrlPosition _leftFilterList;private _controls=((allControls _asy_display) select{((ctrlParentControlsGroup _x) isEqualTo _leftListGroup)&&!((ctrlIDC _x) in[1000,1002,1003])});_leftListGroup ctrlSetPosition[_leftFilterListPosition select 0,_leftFilterListPosition select 1];{_x ctrlSetPosition[(ctrlPosition _x) select 0,((ctrlPosition _x) select 1)+(_leftFilterListPosition select 3)+0.0055]}forEach _controls;