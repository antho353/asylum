#include"..\..\..\..\..\..\..\macro.h"
if(scriptAvailable(5)) exitWith{["You can only attempt to do create a listing every couple seconds for the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;};private _lockTrunk={params["_vehicle"];_vehicle setVariable["ga_activeTrunk",player,true];_vehicle setVariable["ga_veh_in_use",player,true];};private _unlockTrunk={params["_vehicle"];_vehicle setVariable["ga_activeTrunk",nil,true];_vehicle setVariable["ga_veh_in_use",nil,true];};if((life_cashCache!=((life_cash/4)+7))||(life_atmcashCache!=((life_atmcash/4)+5))) exitWith{[["-HACKEDMONEY-",player,profileName,format["File: %1 - money tampering attempted! Cash: %2 - Expected cash: %3 | Bank: %4 - Expected bank: %5.",_fnc_scriptName,[life_cash]call life_fnc_numberText,[((life_cashCache-7)*4)]call life_fnc_numberText,[life_atmCash]call life_fnc_numberText,[((life_atmCashCache-5)*4)]call life_fnc_numberText]],"TON_fnc_logIt",2]spawn life_fnc_MP;[[profileName,"Attempting to hack money variable."],"life_fnc_notifyAdmins",-2,false]spawn life_fnc_MP;["MemHackCash",false,false]call compile PreProcessFileLineNumbers"\a3\functions_f\Misc\fn_endMission.sqf";};params["_target","_caller","_actionID","_listType"];if(_listType isEqualTo"") exitWith{};if!(SRV_exchangeIsReady) exitWith{["The Asylum Exchange is still being initialized, wait a moment!","basic"]};life_lagRandomID=round(random(800));life_exchangeMaxListings=[0,0,0];if(life_exchangeMaxListings isEqualTo[0,0,0]||!(life_exchangeRequested)) then{life_exchangeRequested=false;[[7,[0,getPlayerUID player,player]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;waitUntil{uiSleep 0.1;life_exchangeRequested};};life_exchangeRequested=false;private _subscriber=call life_subscribed;life_exchangeMaxListings params["_maxVirtualListing","_maxPhysicalListing","_maxVehicleListing"];switch(_listType) do{case"virtualItem":{if(!_subscriber&&_maxVirtualListing>=10) exitWith{[format["You can only have 10 listings of virtual items in the Asylum Exchange, clear out your Asylum Exchange listings to list more. You currently have %1 virtual item listings listed. Asylum Subscribers recieve an extra 10 virtual item listing space in the Asylum Exchange.",_maxVirtualListing],"basic"]spawn life_fnc_handleMessage;};if(_subscriber&&_maxVirtualListing>=20) exitWith{[format["You can only have 20 listings of virtual items in the Asylum Exchange, clear out your Asylum Exchange listings to list more. You currently have %1 virtual item listings listed. ",_maxVirtualListing],"basic"]spawn life_fnc_handleMessage;};private _nearVehicles=nearestObjects[getPos player,["Car","Air","Ship"],35];private _vehicle=_nearVehicles param[_nearVehicles findIf{(((_x getVariable["ga_vehOwners",[[]]]param[0,[]]) param[0,""]) isEqualTo getPlayerUID player)&&((_x getVariable["ga_activeTrunk",objNull]) isEqualTo objNull)&&((_x getVariable["ga_veh_in_use",objNull]) isEqualTo objNull)&&alive _x},objNull];[_vehicle]call _lockTrunk;if(isNull _vehicle||isNil"_vehicle") exitWith{[_vehicle]call _unlockTrunk;["There isn't a vehicle near the NPC to list virtual items from that you own!","basic"]spawn life_fnc_handleMessage };private _dialogQuestion=["For the virtual item you decide to list, the entire amount of that item in your vehicle's trunk will be listed on the Asylum Exchange","Asylum Exchange","Okay","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{[_vehicle]call _unlockTrunk;["You chose not to list your resources on the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;};private _whitelisteVirtualItems=([1,"virtualItem"]call life_fnc_exchangeCfg);private _selectedVirtualItems=[];private _toExit=false;(_vehicle getVariable["ga_vinv",[[],0]]) params["_vehItems","_vehWeight"];{_x params["_vItem","_vItemAmount"];_index=_whitelisteVirtualItems findIf{_vItem in _x};if!(_index isEqualTo-1) then{private _dialogQuestion=[format["Would you like to list your %1(s) from your %2's trunk?",["getName",_vItem]call life_fnc_virtItemCfg,[configFile>>"CfgVehicles">>typeOf _vehicle]call BIS_fnc_displayName],"Asylum Exchange","Yes","No"]call BIS_fnc_guiMessage;if(_dialogQuestion) exitWith{_toExit=true;};};if(_toExit) exitWith{_selectedVirtualItems pushBack[_x];_vehItems=_vehItems-[_x];};}forEach _vehItems;if(_selectedVirtualItems isEqualTo[]) exitWith{[_vehicle]call _unlockTrunk;["You didn't choose a resource to list OR you had no whitelisted virtual items in your trunk!","basic"]spawn life_fnc_handleMessage;};(_selectedVirtualItems select 0) params["_selectedItemData"];_selectedItemData params["_selVItem","_selVItemAmount"];if(_selVItemAmount<(["getMinimumQuantity",_selVItem]call life_fnc_exchangeCfg)) exitWith{[_vehicle]call _unlockTrunk;[format["You need at least an amount of %1 to list your %2(s) on the Asylum Exchange!",(["getMinimumQuantity",_selVItem]call life_fnc_exchangeCfg),["getName",_selVItem]call life_fnc_virtItemCfg],"basic"]spawn life_fnc_handleMessage;};if(_selVItemAmount>(["getMaximumQuantity",_selVItem]call life_fnc_exchangeCfg)) exitWith{[_vehicle]call _unlockTrunk;[format["You can't list more than %1 of %2(s) on the Asylum Exchange!",(["getMaximumQuantity",_selVItem]call life_fnc_exchangeCfg),["getName",_selVItem]call life_fnc_virtItemCfg],"basic"]spawn life_fnc_handleMessage;};["asy_exchange_input"]call life_fnc_createDialog;((findDisplay 781000) displayCtrl 781001) ctrlSetText(format["Enter the selling price for your per unit of %1",["getName",_selVItem]call life_fnc_virtItemCfg]);waitUntil{!(isNull(findDisplay 781000))};waitUntil{(isNull(findDisplay 781000)||life_exchangeInput)};if!(life_exchangeInput) exitWith{[_vehicle]call _unlockTrunk;};life_exchangeInput=false;private _inputedAskingPriceString=ctrlText 781002;private _inputedAskingPrice=[_inputedAskingPriceString]call BIS_fnc_parseNumber;if(_inputedAskingPrice isEqualTo-1) exitWith{[format["You've entered %1, which isn't a real number!",_inputedAskingPriceString],"basic"]spawn life_fnc_handleMessage;closeDialog 0;[_vehicle]call _unlockTrunk;};if(_inputedAskingPrice<(["getMinimumPrice",_selVItem]call life_fnc_exchangeCfg)) exitWith{[format["You've entered %1, but the minimum price you can input is %2!",[_inputedAskingPrice]call life_fnc_numberText,[(["getMinimumPrice",_selVItem]call life_fnc_exchangeCfg)]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;closeDialog 0;[_vehicle]call _unlockTrunk;};if(_inputedAskingPrice>(["getMaximumPrice",_selVItem]call life_fnc_exchangeCfg)) exitWith{[format["You've entered %1, but the maximum price you can input is %2!",[_inputedAskingPrice]call life_fnc_numberText,[(["getMaximumPrice",_selVItem]call life_fnc_exchangeCfg)]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;closeDialog 0;[_vehicle]call _unlockTrunk;};if(_selVItem isEqualTo""||_selVItemAmount isEqualTo 0) exitWith{[_vehicle]call _unlockTrunk;};private _listingFee=((_inputedAskingPrice*_selVItemAmount)*0.05);if(life_atmcash<_listingFee) exitWith{[_vehicle]call _unlockTrunk;[format["You do not have $%1 in your bank account, To afford the listing fee for this item!",[_listingFee]call life_fnc_numberText],"basic"]spawn life_fnc_handleMessage;};private _dialogQuestion=[format["Are you willing to pay a total listing fee of $%1 for %2 %3(s)?",[_listingFee]call life_fnc_numberText,_selVItemAmount,["getName",_selVItem]call life_fnc_virtItemCfg],"Asylum Exchange","Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{["You chose not to list your resources on the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;closeDialog 0;[_vehicle]call _unlockTrunk;};private _randID=life_lagRandomID;life_didServerRespond=false;private _maxDelayTime=time+5;[[player],"TON_fnc_lagCheck",2]spawn life_fnc_MP;waitUntil{time>_maxDelayTime||life_didServerRespond};if(time>_maxDelayTime) exitWith{["Exchange failed, try again.","basic"]spawn life_fnc_handleMessage;[_vehicle]call _unlockTrunk;};if!(_randID isEqualTo life_lagRandomID) exitWith{["Please wait for the exchange...","basic"]spawn life_fnc_handleMessage;[_vehicle]call _unlockTrunk;};life_atmcash=life_atmcash-_listingFee;life_atmcashCache=((life_atmcash/4)+5);[1]call life_fnc_ClUpdatePartial;_vehWeight=_vehWeight-(_selVItemAmount*(["getItemWeight",_selVItem]call life_fnc_virtItemCfg));_vehicle setVariable["ga_vinv",[_vehItems,_vehWeight],true];[_vehicle]call _unlockTrunk;[format["Your %4 %1(s) have been listed on the Asylum Exchange for $%2 each with a listing fee of $%3. If your listing fails to sell within 7 days then your items will be put into your Asylum Exchange Storage!",["getName",_selVItem]call life_fnc_virtItemCfg,[_inputedAskingPrice]call life_fnc_numberText,[_listingFee]call life_fnc_numberText,_selVItemAmount],"exchange"]spawn life_fnc_handleMessage;[[1,[1,player,getPlayerUID player,_selVItem,_inputedAskingPrice,_selVItemAmount,_listingFee]],"TON_fnc_exchangeSystemSRV",2]spawn life_fnc_MP;[["-EXCHANGELISTED-",player,(profileName),format["Created a virtual item listing: Item: %1, Quantity Inputed: %2, Set Price: $%3, Fee: $%4",["getName",_selVItem]call life_fnc_virtItemCfg,_selVItemAmount,[_inputedAskingPrice]call life_fnc_numberText,[_listingFee]call life_fnc_numberText]],"TON_fnc_logIt",2]spawn life_fnc_MP;closeDialog 0;};case"vehicleItem":{if(!_subscriber&&_maxVehicleListing>=10) exitWith{[format["You can only have 10 listings of vehicles in the Asylum Exchange, clear out your Asylum Exchange listings to list more. You currently have %1 vehicle listings listed. Asylum Subscribers recieve an extra 10 vehicle listing space in the Asylum Exchange.",_maxVehicleListing],"basic"]spawn life_fnc_handleMessage;};if(_subscriber&&_maxVehicleListing>=20) exitWith{[format["You can only have 20 listings of vehicles in the Asylum Exchange, clear out your Asylum Exchange listings to list more. You currently have %1 vehicle listings listed. ",_maxVehicleListing],"basic"]spawn life_fnc_handleMessage;};private _vehicleObject=cursorObject;private _vehicleObjectPos=(getPos _vehicleObject);private _vehicleClassname=(typeOf _vehicleObject);private _vehicleDisplayName=[configFile>>"CfgVehicles">>_vehicleClassname]call BIS_fnc_displayName;private _whitelistedVehicles=([1,"vehicle"]call life_fnc_exchangeCfg);if(isNull _vehicleObject||!(alive _vehicleObject)||!(_vehicleClassname in _whitelistedVehicles)) exitWith{["This vehicle isn't accepted into the exchange!"]spawn life_fnc_handleMessage;};private _vehicleOwnerUID=(_vehicleObject getVariable["ga_dbInfo",[]]select 0);private _vehiclePlateID=(_vehicleObject getVariable["ga_dbInfo",[]]select 1);if!((getPlayerUID player) isEqualTo _vehicleOwnerUID) exitWith{["You must own this vehicle to put it up on the Asylum Exchange!"]spawn life_fnc_handleMessage;};if(""in[_vehicleOwnerUID,_vehiclePlateID]) exitWith{["You cannot list this vehicle!"]spawn life_fnc_handleMessage;};[getItemCargo _vehicleObject,getWeaponCargo _vehicleObject,getMagazineCargo _vehicleObject,getBackpackCargo _vehicleObject]params["_vehItem","_vehWeapon","_vehAmmo","_vehBackpack"];