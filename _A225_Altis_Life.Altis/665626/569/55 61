#include"..\..\macro.h"
if(scriptAvailable(5)) exitWith{["You can only attempt to manage a listing every couple seconds in the Asylum Exchange!","basic"]spawn life_fnc_handleMessage;};if((life_cashCache!=((life_cash/4)+7))||(life_atmcashCache!=((life_atmcash/4)+5))) exitWith{[["-HACKEDMONEY-",player,profileName,format["File: %1 - money tampering attempted! Cash: %2 - Expected cash: %3 | Bank: %4 - Expected bank: %5.",_fnc_scriptName,[life_cash]call life_fnc_numberText,[((life_cashCache-7)*4)]call life_fnc_numberText,[life_atmCash]call life_fnc_numberText,[((life_atmCashCache-5)*4)]call life_fnc_numberText]],"TON_fnc_logIt",2]spawn life_fnc_MP;[[profileName,"Attempting to hack money variable."],"life_fnc_notifyAdmins",-2,false]spawn life_fnc_MP;["MemHackCash",false,false]call compile PreProcessFileLineNumbers"\a3\functions_f\Misc\fn_endMission.sqf";};life_exchangeStorageMaxListings params["_maxVirtualListing","_maxPhysicalListing"];params[["_selectedType","",[""]],["_control",controlNull]];if(isNull _control) exitWith{};if(_selectedType isEqualTo"") exitWith{};if!(ctrlEnabled _control) exitWith{};private _asy_display=findDisplay 875000;private _menuTitle=_asy_display displayCtrl 875002;private _mainFilterList=_asy_display displayCtrl 875003;private _leftFilterList=_asy_display displayCtrl 875004;private _mainListGroup=_asy_display displayCtrl 875005;private _mainItemList=_mainListGroup controlsGroupCtrl 1000;private _mainItemListBackground=_mainListGroup controlsGroupCtrl 1003;private _leftListGroup=_asy_display displayCtrl 875006;private _leftItemList=_leftListGroup controlsGroupCtrl 1000;private _leftItemListBackground=_mainListGroup controlsGroupCtrl 1003;private _rightListGroup=_asy_display displayCtrl 875007;private _rightItemList=_rightListGroup controlsGroupCtrl 1000;private _retractListingButton=_mainListGroup controlsGroupCtrl 1001;private _purchaseListingButton=_rightListGroup controlsGroupCtrl 1001;private _checkAvailButton=_leftListGroup controlsGroupCtrl 1001;private _mainFilterListSelect=lbCurSel _mainFilterList;private _leftFilterListSelect=lbCurSel _leftFilterList;private _leftItemListSelect=lbCurSel _leftItemList;private _mainItemListSelect=lbCurSel _mainItemList;if((_control isEqualTo _retractListingButton)&&(_mainItemListSelect isEqualTo-1)) exitWith{["You need to select your listing to retract it!","basic"]spawn life_fnc_handleMessage;};if((_control isEqualTo _purchaseListingButton)&&(_mainItemListSelect isEqualTo-1)) exitWith{["You need to select a listing to buy!","basic"]spawn life_fnc_handleMessage;};if((_control isEqualTo _checkAvailButton)&&(_leftItemListSelect isEqualTo-1)) exitWith{["You need to select a resource to search for one!","basic"]spawn life_fnc_handleMessage;};private _listingInfo=switch(_control) do{case _retractListingButton:{[_mainItemList lnbData[_mainItemListSelect,0]]};case _purchaseListingButton:{[_mainItemList lnbData[_mainItemListSelect,0]]};case _checkAvailButton:{[_leftItemList lnbData[_leftItemListSelect,0]]};default{[]};};switch(_selectedType) do{case"checkListing":{_listingInfo params["_resourceSearchTerm"];private _filterType=_leftFilterList lbData _leftFilterListSelect;private _listingItemData=[];switch(_filterType) do{case"Virtual Items":{_listingItemData=[_resourceSearchTerm,(["getName",_resourceSearchTerm]call life_fnc_virtItemCfg),(["getIcon",_resourceSearchTerm]call life_fnc_virtItemCfg)];};default{_listingItemData=[_resourceSearchTerm]call life_fnc_fetchCfgDetails};};_listingItemData params["_resourceString","_resourceDisplayName","_resourceImage"];private _dialogQuestion=[format["Would you like to search for selected item: %1 on the Asylum Exchange?",_resourceDisplayName],format["Asylum Exchange Search: %1",_resourceDisplayName],"Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{};[format["Searching for %1 on the Asylum Exchange...",_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;if(life_exchangeSpecificedListing isEqualTo[]||!(life_exchangeRequested)) then{life_exchangeRequested=false;[[5,[1,getPlayerUID player,player,_resourceSearchTerm]],"TON_fnc_exchangeSystemSRV",2]call life_fnc_MP;waitUntil{uiSleep 0.1;life_exchangeRequested};};life_exchangeRequested=false;life_exchangeSelectedResource="";_mainFilterList lbDelete 2;private _titleText=format["Searched: %1",_resourceDisplayName];private _index=_mainFilterList lbAdd _titleText;_mainFilterList lbSetData[_index,_titleText];life_exchangeSelectedResource=_titleText;lbClear _mainItemList;_mainFilterList lbSetCurSel 2;if(life_exchangeSpecificedListing isEqualTo[]) then{[format["It appears there are no listings for %1 on the Asylum Exchange",_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;}else{[format["The %1 cheapest listing(s) on the entire Asylum Exchange for %2 have been fetched.",count life_exchangeSpecificedListing,_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;};};case"purchaseListing":{_listingInfo=parseSimpleArray(_listingInfo select 0);_listingInfo params["_exchangeID","_playerUID","_playerName","_itemClassname","_vehicleID","_sellingPrice","_itemQuantity","_isVirtual","_isPhysical","_isVehicle","_expiresTimeArray","_boughtTimeArray"];if(_isVirtual isEqualTo 1&&_maxVirtualListing>=5) exitWith{[format["You can only have 5 listings of virtual items in your Exchange Storage, clear out your Exchange Storage to retrieve more. You currently have %1 virtual item listings in storage.",_maxVirtualListing],"basic"]spawn life_fnc_handleMessage;};if(_isPhysical isEqualTo 1&&_maxPhysicalListing>=5) exitWith{[format["You can only have 5 listings of physical items in your Exchange Storage, clear out your Exchange Storage to retrieve more. You currently have %1 physical item listings in storage.",_maxPhysicalListing],"basic"]spawn life_fnc_handleMessage;};if(_playerUID isEqualTo(getPlayerUID player)) exitWith{};life_lagRandomID=round(random(800));if(_isVehicle isEqualTo 1) then{life_garageCount=-1;[[getPlayerUID player,playerSide,player],"TON_fnc_garageCount",2]spawn life_fnc_MP;};private _listingItemData=[];switch(true) do{case(_isVirtual isEqualTo 1):{_listingItemData=[_itemClassname,(["getName",_itemClassname]call life_fnc_virtItemCfg),(["getIcon",_itemClassname]call life_fnc_virtItemCfg)];};default{_listingItemData=[_itemClassname]call life_fnc_fetchCfgDetails};};_listingItemData params["_resourceString","_resourceDisplayName","_resourceImage"];if(_isPhysical isEqualTo 1) exitWith{private _dialogQuestion=[format["Would you like to purchase %1 which has a stock of %3 and sells for $%2 x 1?",_resourceDisplayName,[_sellingPrice]call life_fnc_numberText,_itemQuantity],"Asylum Exchange Purchase Listing","Yes","No"]call BIS_fnc_guiMessage;if!(_dialogQuestion) exitWith{};["Enter the amount you want to purchase!","basic"]spawn life_fnc_handleMessage;["asy_exchange_input"]call life_fnc_createDialog;((findDisplay 781000) displayCtrl 781001) ctrlSetText(format["Enter the amount of %1 you want to purchase",_resourceDisplayName]);waitUntil{!(isNull(findDisplay 781000))};waitUntil{(isNull(findDisplay 781000)||life_exchangeInput)};if!(life_exchangeInput) exitWith{["You chose not to purchase the selected listing!"]spawn life_fnc_handleMessage};life_exchangeInput=false;private _inputedWantedAmountString=ctrlText 781002;private _inputedWantedAmount=[_inputedWantedAmountString]call BIS_fnc_parseNumber;if(_inputedWantedAmount isEqualTo-1) exitWith{[format["You've entered %1, which isn't a real number!",_inputedWantedAmountString],"basic"]spawn life_fnc_handleMessage;closeDialog 0;};if(_inputedWantedAmount>_itemQuantity) exitWith{[format["You can't purchase more than what is currently available! You requested %1 while the stock was only %2!",_inputedWantedAmount,_itemQuantity]]spawn life_fnc_handleMessage;closeDialog 0;};if(_inputedWantedAmount<1) exitWith{[format["You can't purchase less than what is currently available! You requested less than 1 while the stock was only %1!",_itemQuantity]]spawn life_fnc_handleMessage;closeDialog 0;};private _totalCashAmount=(_inputedWantedAmount*_sellingPrice);if(life_atmcash<_totalCashAmount) exitWith{[format["You do not have $%1 in your bank account, To afford a listing of %2(s)!",[_listingFee]call life_fnc_numberText,_resourceDisplayName],"basic"]spawn life_fnc_handleMessage;};private _randID=life_lagRandomID;life_didServerRespond=false;private _maxDelayTime=time+5;[[player],"TON_fnc_lagCheck",2]spawn life_fnc_MP;waitUntil{time>_maxDelayTime||life_didServerRespond};if(time>_maxDelayTime) exitWith{["Exchange failed, try again.","basic"]spawn life_fnc_handleMessage;